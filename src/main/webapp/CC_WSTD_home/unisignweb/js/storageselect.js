var __storageselect=function(a){var x=function(b){function v(f){if(!f)return alert("UI load error."),!1;if("CERT_STORAGE"===b.type)a.ESVS.TargetObj.innerHTML=f;else{var c=document.createElement("div");document.body.insertBefore(c,document.body.firstChild);c.innerHTML=f}return!0}function q(f,c,b){if(a.CONST.__USFB_M_DISK.device>f||!c||!b)return!1;var e=a.loadUI("driveselect")({type:"DEVICE_REMOVABLE_DISK",args:c,onConfirm:function(a){g=f;h=a;e.dispose();b.focus()},onCancel:function(){e.dispose();b.focus()}});e.show()}function m(f,c,b){var e=a.loadUI("sectokenselect")({type:f,args:c,onConfirm:function(a){g=f;h=a;t=c.list[a-1].name;e.dispose();b.focus()},onCancel:function(){e.dispose();b.focus()}});e.show()}function r(f,c,b){if(a.CONST.__USFB_M_DISK.device>f||!c||!b)return!1;var e=a.loadUI("driveselect")({type:"DEVICE_SAVE_TOKEN",args:c,onConfirm:function(a){g=f;h=a;e.dispose();b.focus()},onCancel:function(){e.dispose();b.focus()}});e.show()}function z(f,c){var l=null;h=g=0;if(4&a.ESVS.Mode)if(a.nimservice())b.args&&"BACKUP_DRIVE"==b.args.drivetype?a.nimservice().GetBackupedDriveList(function(e,k,g){if(0==e&&g)if(k=g.length,0<k){e=[];for(var d=0;d<k;d++){var p={};p.index=d+1;p.name=g[d];e[d]=p}l={list:e}}else a.uiUtil().loadingBox(!1,"us-div-list-load"),a.uiUtil().msgBox(c.IDS_MSGBOX_NOT_INSERT_BACKUPEDDISK,e),b.onCancel();else a.uiUtil().loadingBox(!1,"us-div-list-load"),a.uiUtil().msgBox(c.IDS_MSGBOX_NOT_INSERT_BACKUPEDDISK,e),b.onCancel();q(a.CONST.__USFB_M_DISK.device,l,f)}):a.nimservice().GetDiskList(function(c,b,g){b=0;g&&(b=g.length);if(0==c&&0<b){c=[];for(var d=0;d<b;d++){var p={};p.index=d+1;p.name=g[d];c[d]=p}l={list:c}}else a.uiUtil().loadingBox(!1,"us-div-list-load"),a.nimservice().GetLastErrorCode();q(a.CONST.__USFB_M_DISK.device,l,f)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;return!0}function A(f,c){var b=null;h=g=0;if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetHSMList(1,function(c,g,w){g=0;w&&(g=w.length);if(0==c&&0<g){c=0;for(var d=[],p=0;p<g;p++){var h={},n=w[p].split("|");h.index=p+1;h.name=n[0];h.driver=n[1];h.passage=n[2];h.validity=n[3];d[c++]=h}b={list:d}}else a.uiUtil().loadingBox(!1,"us-div-list-load"),a.nimservice().GetLastErrorCode();m(a.CONST.__USFB_M_HSMKEY.device,b,f)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;return!0}function u(f,c){if(!f||!c)return!1;a.uiUtil().MsgBox(c.IDS_MSGBOX_NOT_SUPPORTED_MEDIA);return!0}function x(f){if(a.CONST.__USFB_M_DISK.device>g||(a.CONST.__USFB_M_DISK.device===g||a.CONST.__USFB_M_HSMKEY.device===g)&&1>h)return a.uiUtil().msgBox(f.IDS_MSGBOX_ERROR_PLEASE_SELECT_STORAGE),!1;if("CERT_COPY"==b.type&&b.args.sourceDevice===g&&b.args.sourceDrive===h)return a.uiUtil().msgBox(f.IDS_MSGBOX_ERROR_WARNING_SAME_STORAGE),!1;if(("CERT_COPY"===b.type||"CERT_IMPORT"===b.type||"CERT_STORAGE"===b.type)&&a.CONST.__USFB_M_SMARTCARD.device===g&&0===h&&!confirm(f.IDS_CONFIRMBOX_WARNING_CHANGE_CERT))return!1;if(g==a.CONST.__USFB_M_SECUREDISK.device)a.nimservice().IsSDInstalled(function(c,l){a.uiUtil().loadingBox(!1,"us-div-list-load");if(0!=c)a.ERROR.Code=31001,a.ERROR.Message=f.IDS_MSGBOX_NOT_INSTALL_SD,confirm(f.IDS_CONFIRMBOX_NOT_INSTALL_SD)&&(document.getElementById("us-storage-select-cancel-btn").click(),null==("firefox"==a.browserName?window.open(a.ESVS.SDInstallURL,"securedisk_url","scrollbars=1, op=100px, left=100px, height=500px, width=380px"):window.open(a.ESVS.SDInstallURL,"securedisk_url","top=100px, left=100px, height=500px, width=380px"))&&a.uiUtil().msgBox(f.IDS_MSGBOX_BLOCK_POPUP_WINDOW));else return b.onConfirm(g,h,t),!0});else if(g==a.CONST.__USFB_M_MOBILETOKEN.device)a.nimservice().IsInstalledUSIMModule(2,!0,function(c,l){a.uiUtil().loadingBox(!1,"us-div-list-load");if(0==c)a.nimservice().SetUSIMOptions(a.usimEnv.sitecode,a.usimEnv.modecode,a.usimEnv.siteURL,a.usimEnv.serviceIP,a.usimEnv.servicePort,a.usimEnv.downloadURL,function(a){b.onConfirm(g,h,t)});else if(4847E4==c&&(a.ERROR.Code=21002,a.ERROR.Message=f.IDS_MSGBOX_NOT_INSTALL_SMARTCERT,confirm(f.IDS_CONFIRMBOX_NOT_INSTALL_SMARTCERT)))if(document.getElementById("us-storage-select-cancel-btn").click(),"firefox"==a.browserName){var e=window.open(a.usimEnv.downloadURL,"usim_url","scrollbars=1, op=100px, left=100px, height=500px, width=380px");null==e&&a.uiUtil().msgBox(__textObjtext.IDS_MSGBOX_BLOCK_POPUP_WINDOW)}else e=window.open(a.usimEnv.downloadURL,"usim_url","top=100px, left=100px, height=500px, width=380px"),null==e&&a.uiUtil().msgBox(f.IDS_MSGBOX_BLOCK_POPUP_WINDOW)});else if(g==a.CONST.__USFB_M_MOBILE.device)a.nimservice().IsUBIkeyInstalled(function(c,l){if(0!=c)a.ERROR.Code=11003,a.ERROR.Message=f.IDS_MSGBOX_NOT_INSTALL_MOBILE,confirm(f.IDS_CONFIRMBOX_NOT_INSTALL_MOBILE)&&(document.getElementById("us-storage-select-cancel-btn").click(),null==("firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"))&&a.uiUtil().msgBox(f.IDS_MSGBOX_BLOCK_POPUP_WINDOW));else b.onConfirm(g,h,t)});else return b.onConfirm(g,h,t),!0}function n(f){if(!f)return!1;for(var c=a.ESVS.Media.list.split("|"),b=0;b<c.length;b++){var e=a.CONST.medias[c[b]];void 0!=e&&null!=e&&(e=document.getElementById("us-btn-storage-"+e.name),void 0!=e&&null!=e&&"us-layout-storage-btn-none"!=e.className&&(e.className=f===e?"us-layout-storage-btn-on":"us-layout-storage-btn-off"))}return!0}function B(b){if(null==b||void 0==b)return!1;var c=!a.uiUtil().isItSupportingThisStorage(b);!1==c&&null!=a.ESVS.Media&&null!=a.ESVS.Media.list&&0>a.ESVS.Media.list.indexOf(b.name)&&(c=!0);if(c)return!1;var c=document.getElementById("us-btn-storage-btn-list"),l=document.createElement("li");l.setAttribute("id","us-storage-btn-li-"+b.name,0);l.setAttribute("mediaIndex",b.mediaIndex,0);7==b.mediaIndex&&(l.className="line-first");"hidden"===b.visibility?(l.style.display="none",l.style.visibility="hidden"):(l.style.display="block",l.style.visibility="visible");var e=document.createElement("button");e.setAttribute("type","button",0);e.setAttribute("id","us-btn-storage-"+b.name,0);e.setAttribute("title",b.label,0);e.setAttribute("tabindex",b.tabIndex,0);b.disabled?(e.onclick=function(){a.uiUtil().msgBox(C.IDS_MSGBOX_NOT_SUPPORTED_MEDIA)},e.className="us-layout-storage-btn-none"):(e.onclick=b.onclick,e.className=b.device===g?"us-layout-storage-btn-on":"us-layout-storage-btn-off");l.appendChild(e);if("harddisk"!==b.name&&"webstorage"!==b.name){var k=document.createElement("span");k.className="us-drive-select";e.appendChild(k)}k=document.createElement("span");k.className="us-img-storage";var h=document.createElement("img");h.setAttribute("id","us-img-storage-"+b.name,0);h.setAttribute("alt",b.label,0);b.disabled?h.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+"_d.png",0):h.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+".png",0);k.appendChild(h);e.appendChild(k);k=document.createElement("span");k.setAttribute("id","us-lbl-storage-"+b.name,0);k.className="us-layout-lbl-storage";k.appendChild(document.createTextNode(b.label));e.appendChild(k);l.appendChild(e);c.appendChild(l);return!0}var D=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/layout/storageselect.html?version="+a.ver,!1);b.send(null);return b.responseText},y=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/"+a.ESVS.Language+"/storageselect_"+a.ESVS.Language+".js?version="+a.ver,!1);b.send(null);return b.responseText},C=eval(eval(y)()),s=a.ESVS.TabIndex,g=a.CONST.__USFB_M_DISK.device,h=0,t="";null!=a.ESVS.Media&&null!=a.ESVS.Media.defaultdevice?g=a.uiUtil().getMediaDevice(a.ESVS.Media.defaultdevice):2==a.ESVS.Mode&&(g=a.CONST.__PF_M_LS.device);return function(){var f=eval(D),c=eval(eval(y)());v(f());f=document.getElementById("us-storage-select-lbl-title");f.appendChild(document.createTextNode(c.IDS_STORAGE_SELECTION));f.setAttribute("tabindex",s++,0);document.getElementById("us-storage-select-cls-btn-img").setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/x-btn.png",0);var l=document.getElementById("us-storage-select-notice-lbl");"CERT_STORAGE"===b.type?l.appendChild(document.createTextNode(c.IDS_SAVE_NOTICE)):l.appendChild(document.createTextNode(c.IDS_COPY_NOTICE));for(var e=0,k=a.ESVS.Media.list.split("|"),m=0;m<k.length;m++){var d=a.CONST.medias[k[m]];if(void 0!=d&&null!=d){switch(d.device){case a.CONST.__USFB_M_DISK.device:d.label=c.IDS_STORAGE_REMOVABLE;d.disabled=2==a.ESVS.Mode||"CERT_COPY"==b.type&&b.args.sourceDevice==a.CONST.__USFB_M_SECUREDISK.device;d.onclick=function(){z(this,c);n(this)};break;case a.CONST.__USFB_M_HSMKEY.device:d.label=c.IDS_STORAGE_SECTOKEN;d.disabled="win"!=a.osName||b.args&&"BACKUP_DRIVE"==b.args.drivetype;d.onclick=function(){A(this,c);n(this)};break;case a.CONST.__USFB_M_SMARTCARD.device:d.label=c.IDS_STORAGE_SAVETOKEN;d.disabled="win"!=a.osName||b.args&&"BACKUP_DRIVE"==b.args.drivetype||"CERT_COPY"==b.type&&b.args.sourceDevice==a.CONST.__USFB_M_SECUREDISK.device;d.onclick=function(){var b=null;h=g=0;var b=[],d={};d.index=a.CONST.__USFB_M_SMARTCARD.device;d.name=c.IDS_SAVETOKEN_SMART_CARD;b[0]=d;b={list:b};r(a.CONST.__USFB_M_SMARTCARD.device,b,this);n(this)};break;case a.CONST.__USFB_M_MOBILE.device:d.label=c.IDS_STORAGE_MOBILEPHONE;d.disabled="CERT_STORAGE"==b.type?!0:"win"!=a.osName||2==a.ESVS.Mode||b.args&&"BACKUP_DRIVE"==b.args.drivetype||"CERT_COPY"==b.type&&b.args.sourceDevice==a.CONST.__USFB_M_SECUREDISK.device;d.onclick=function(){g=a.CONST.__USFB_M_MOBILE.device;this.focus();n(this)};break;case a.CONST.__USFB_M_HDD.device:d.label=c.IDS_STORAGE_HARDDISK;d.disabled=2==a.ESVS.Mode||b.args&&"BACKUP_DRIVE"==b.args.drivetype||"CERT_COPY"==b.type&&b.args.sourceDevice==a.CONST.__USFB_M_SECUREDISK.device;d.onclick=function(){g=a.CONST.__USFB_M_HDD.device;this.focus();n(this)};break;case a.CONST.__USFB_M_MOBILETOKEN.device:d.label=c.IDS_STORAGE_MOBILETOKEN;d.disabled="CERT_STORAGE"==b.type?!0:"win"!=a.osName||2==a.ESVS.Mode||b.args&&"BACKUP_DRIVE"==b.args.drivetype||"CERT_COPY"==b.type&&b.args.sourceDevice==a.CONST.__USFB_M_SECUREDISK.device;d.onclick=function(){g=a.CONST.__USFB_M_MOBILETOKEN.device;this.focus();n(this)};break;case a.CONST.__USFB_M_SECUREDISK.device:d.label=c.IDS_STORAGE_SECUREDISK;d.disabled="win"!=a.osName||2==a.ESVS.Mode||b.args&&"BACKUP_DRIVE"==b.args.drivetype||"CERT_COPY"==b.type&&b.args.sourceDevice==a.CONST.__USFB_M_SECUREDISK.device;d.onclick=function(){g=a.CONST.__USFB_M_SECUREDISK.device;h=1;this.focus();n(this)};break;case a.CONST.__PF_M_LS.device:d.label=c.IDS_STORAGE_LS;d.disabled="CERT_STORAGE"==b.type?!0:1==a.ESVS.Mode||"CERT_COPY"==b.type;d.onclick=function(){g=a.CONST.__PF_M_LS.device;this.focus();n(this)};break;case a.CONST.__PF_M_SS.device:d.label=c.IDS_STORAGE_SS;d.disabled="CERT_STORAGE"==b.type?!0:1==a.ESVS.Mode||"CERT_COPY"==b.type;d.onclick=function(){g=a.CONST.__PF_M_SS.device;this.focus();n(this)};break;case a.CONST.__PF_M_TOUCHSIGN.device:d.label=c.IDS_STORAGE_TOUCHSIGN;d.disabled=!0;d.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_SMARTSIGN.device:d.label=c.IDS_STORAGE_SMARTSIGN;d.disabled=!0;d.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_WEBSECTOKEN.device:d.label=c.IDS_STORAGE_WEBSECTOKEN;d.disabled=!0;d.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_WEBSOFTTOKEN.device:d.label=c.IDS_STORAGE_WEBSOFTTOKEN;d.disabled=!0;d.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_CLOUDSIGN.device:d.label=c.IDS_STORAGE_CLOUDSIGN;d.disabled="CERT_STORAGE"==b.type?!0:1==a.ESVS.Mode;d.onclick=function(){g=a.CONST.__PF_M_CLOUDSIGN.device;this.focus();n(this)};break;default:d.label=c.IDS_STORAGE_ETC,d.disabled=!0,d.onclick=function(){u(this,c)}}d.tabIndex=s;d.mediaIndex=e+1;d.visibility="visible";B(d)&&(s++,e++,1==e&&document.getElementById("us-btn-storage-"+d.name))}}document.getElementById("us-storage-select-warning-lbl").appendChild(document.createTextNode(c.IDS_WARNING));e=document.getElementById("us-storage-select-confirm-btn");e.setAttribute("value",c.IDS_CONFIRM,0);e.setAttribute("title",c.IDS_CONFIRM+c.IDS_BUTTON,0);e.setAttribute("tabindex",s++,0);e.onclick=function(){x(c)};k=document.getElementById("us-storage-select-cancel-btn");k.setAttribute("value",c.IDS_CANCEL,0);k.setAttribute("title",c.IDS_CANCEL+c.IDS_BUTTON,0);k.setAttribute("tabindex",s++,0);k.onclick=function(){b.onCancel()};m=document.getElementById("us-storage-select-cls-img-btn");m.setAttribute("tabindex",s++,0);m.onclick=function(){b.onCancel()};a.uiUtil().setRotationTabFocus(k,e,f);a.uiUtil().setRotationTabFocus(f,k,l);return document.getElementById("us-div-storage-select")}()};return function(b){var v=a.uiLayerLevel,q=a.uiUtil().getOverlay(v),m=x({type:b.type,args:b.args,onConfirm:b.onConfirm,onCancel:b.onCancel});m.style.zIndex=v+1;a.ESVS.TargetObj.insertBefore(q,a.ESVS.TargetObj.firstChild);var r=window.onresize;return{show:function(){a.ActiveUI=this;draggable(m,document.getElementById("us-div-storage-select-title"));q.style.display="block";a.uiUtil().offsetResize(m);window.onresize=function(){a.uiUtil().offsetResize(m);r&&r()};a.uiLayerLevel+=10;a.ESVS.TabIndex+=30;setTimeout(function(){var a=m.getElementsByTagName("p");if(0<a.length)for(var b=0;b<a.length;b++)"us-storage-select-lbl-title"==a[b].id&&a[b].focus()},10)},hide:function(){q.style.display="none";m.style.display="none"},dispose:function(){window.onresize=function(){r&&r()};"CERT_STORAGE"===b.type?m.parentNode.removeChild(m):m.parentNode.parentNode.removeChild(m.parentNode);q.parentNode.removeChild(q);a.uiLayerLevel-=10;a.ESVS.TabIndex-=30}}}};