var __importcert=function(a){function m(a,e){for(var c=document.getElementsByClassName(a),h=0;h<c.length;h++)c[h].classList.contains(e)||c[h].classList.add(e)}function e(a,e){for(var c=document.getElementsByClassName(a),h=0;h<c.length;h++)c[h].classList.remove(e)}function s(a,e){return 0==document.getElementsByClassName(a).length?!1:document.getElementsByClassName(a)[0].classList.contains(e)}var y=function(p){function u(a){if(!a)return alert("UI load error."),!1;var b=document.createElement("div");document.body.insertBefore(b,document.body.firstChild);b.innerHTML=a;return!0}function c(a){return document.getElementById(a)}function h(a,b){var g=c(a);g.appendChild(document.createTextNode(b));g.setAttribute("tabindex",q++,0);return g}function t(a,b){for(var g=c(a),d=0;d<g.children.length;d++)g.children[d].appendChild(document.createTextNode(b[d]));return g}function z(f,b){var g=document.getElementById(f);g.setAttribute("src",a.ESVS.SRCPath+b,0);return g}var D=function(){var f;f=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");f.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/layout/importCertWithDD.html?V="+a.ver,!1);f.send(null);return f.responseText},y=function(){var f;f=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");f.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/"+a.ESVS.Language+"/importcert_"+a.ESVS.Language+".js?V="+a.ver,!1);f.send(null);return f.responseText},k=null,q=a.ESVS.TabIndex,l={filelist:[]},v=function(a){var b=new FileReader;b.onload=function(b){l.filelist.push({name:a.name,data:b.target.result.toBase64()});"pfx"==l.type?(A(),e("us-pfx-name","hide"),c("us-txt-pfx-name").classList.remove("hide"),c("us-txt-pfx-name").innerHTML=l.filelist[0].name,m("view-panel","hide"),e("cert-info","hide"),e("us-cert-import-content","drop-here"),e("us-cert-import-content","drag"),m("us-cert-import-content","drop")):"fullpfx"==l.type&&4==l.filelist.length?B():"signpfx"==l.type&&2==l.filelist.length&&B()};b.readAsArrayBuffer(a)},A=function(){m("us-list-sublist","hide");m("us-pfx-name","hide");e("password","hide");c("us-div-pfx-download").classList.add("hide");c("us-cert-import-pfx-download").checked=!1},B=function(){A();a.usWebToolkit.x509Certificate.parser(n("signCert"),"Base64");l.certattr={issuer:a.certUtil().getO(a.usWebToolkit.x509Certificate.getSubjectName()),expire:a.certUtil().getLocalDate(a.usWebToolkit.x509Certificate.getNotAfter()),name:a.certUtil().getCN(a.usWebToolkit.x509Certificate.getSubjectName()),dn:a.usWebToolkit.x509Certificate.getSubjectName()};c("us-div-pfx-download").classList.remove("hide");e("us-list-sublist","hide");for(var f=document.getElementsByClassName("us-list-sublist"),b=0;b<f.length-1;b++)f[b].children[1].innerHTML=l.certattr[f[b].classList[1]];c("us-cert-import-pfx-download").checked=!1;m("view-panel","hide");e("cert-info","hide");e("us-cert-import-content","drop-here");e("us-cert-import-content","drag");m("us-cert-import-content","drop")},C=function(){var f=c("us-pw-text").value,b=null;if(1>f.length)return k.IDS_ERROR.INPUT_PASSWORD;if("pfx"==l.type){b=l.filelist[0].data;try{var g=a.usWebToolkit.util.decode64(b),d=der=crosscert.asn1.fromDer(g);a.usWebToolkit.pkcs12.getCertNKeyFromPKCS12(d,f)}catch(e){return 115010==e.code?k.IDS_ERROR.NO_MATCH_PASSWORD:"Error Message : "+e.message+" \nError Code : "+e.code}}else{b=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(n("signPri"));g=a.usWebToolkit.pkcs8.checkUserCertPassword(b,f);if(!g)return k.IDS_ERROR.NO_MATCH_PASSWORD;var d=a.usWebToolkit.pki.certificateFromBase64(n("signCert")),h=null,w=null;if("fullpfx"==l.type&&(h=a.usWebToolkit.pki.certificateFromBase64(n("kmCert")),w=a.usWebToolkit.pkcs8.encryptedPrivateKeyFromBase64(n("kmPri")),g=a.usWebToolkit.pkcs8.checkUserCertPassword(w,f),!g))return k.IDS_ERROR.NO_MATCH_PASSWORD;b=a.usWebToolkit.pkcs12.makePKCS12(d,b,h,w,f,{useMac:!0,generateLocalKeyId:!0});d=a.usWebToolkit.asn1.toDer(b).getBytes();b=a.usWebToolkit.util.encode64(d);c("us-cert-import-pfx-download").checked&&a.fileUtil().save(l.certattr.dn+".pfx",b.toArrayBuffer())}p.onConfirm(b,f);return null},n=function(a){for(var b=0;b<l.filelist.length;b++)if(l.filelist[b].name.startsWith(a))return l.filelist[b].data;return null},x=function(a){if(1==a.length){var b=a[0];return"application/x-pkcs12"==b.type&&(b.name.toLowerCase().endsWith(".pfx")||b.name.toLowerCase().endsWith(".p12"))?(l.type="pfx",null):k.IDS_ERROR.NO_P12_FILE}if(2==a.length||4==a.length){for(var c=0,d=0,e=0;e<a.length;e++)b=a[e],"signcert.der"==b.name.toLowerCase()||"signcert.cer"==b.name.toLowerCase()?c+=1:"signpri.key"==b.name.toLowerCase()?c+=3:"kmcert.der"==b.name.toLowerCase()||"kmcert.cer"==b.name.toLowerCase()?d+=1:"kmpri.key"==b.name.toLowerCase()&&(d+=3);if(0==c)return k.IDS_ERROR.NO_SIGNCERT;if(1==c)return k.IDS_ERROR.NO_SIGNPRIKEY;if(3==c||4!=c)return k.IDS_ERROR.NO_SIGNCERT;if(4==a.length){if(0==d)return k.IDS_ERROR.NO_KMCERT;if(1==d)return k.IDS_ERROR.NO_KMPRIKEY;if(3==d||4!=d)return k.IDS_ERROR.NO_KMCERT;l.type="fullpfx"}else l.type="signpfx";return null}return k.IDS_ERROR.INVALID_FILE_COUNT};return function(){var f=eval(D);k=eval(eval(y)());u(f());var f=c("us-div-import-cert"),b=h("us-import-cert-lbl-title",k.IDS_TITLE);b.setAttribute("tabindex",q,0);z("us-cls-btn-img","unisignweb/rsrc/img/x-btn.png");document.getElementById("us-cls-btn").onclick=function(a){p.onCancel()};t("us-content-basic-notice-ul",k.IDS_CONTENT_NOTICE_UL);t("us-content-drop-plz-ul",k.IDS_CONTENT_DROP_UL);z("us-import-cert-img","unisignweb/rsrc/img/cert_valid.png");for(var g=document.getElementsByClassName("us-list-sublist"),d=0;d<g.length;d++)g[d].children[0].appendChild(document.createTextNode(k.IDS_CERT_INFO[g[d].classList[1]]));a.uiUtil().addCapsLockEvent("us-pw-text","us-import-cert-err-msg-capslock",k.IDS_MSGBOX_CAPSLOCK_ON,null);g=c("us-pw-text");g.setAttribute("tabindex",q+2,0);g.onkeydown=function(a){13==a.keyCode&&(a=C(),null!=a&&alert(a))};g.onkeyup=function(a){a.getModifierState("CapsLock")?document.getElementById("us-import-cert-err-msg-capslock").style.display="block":document.getElementById("us-import-cert-err-msg-capslock").style.display="none"};d=h("us-cert-import-pfx-download-txt",k.IDS_PFX_DOWNLOAD);d.setAttribute("tabindex",q+3,0);d.onclick=function(){c("us-cert-import-pfx-download").checked=!c("us-cert-import-pfx-download").checked};d.onkeydown=function(a){13==a.keyCode&&(c("us-cert-import-pfx-download").checked=!c("us-cert-import-pfx-download").checked)};d=c("us-btn-cert-import");d.value=k.IDS_CERT_IMPORT;d.setAttribute("tabindex",q+4,0);d.onclick=function(a){a.preventDefault();a.returnValue=!1;a.cancelBubble=!0;a=C();null!=a&&alert(a)};d=c("us-btn-re-try");d.setAttribute("tabindex",q+5,0);d.value=k.IDS_RE_TRY;d.onclick=function(a){a.preventDefault();a.returnValue=!1;a.cancelBubble=!0;l={filelist:[]};e("us-cert-import-content","drop-here");m("us-cert-import-content","drag");m("view-panel","hide");e("basic","hide");c("us-pw-text").value="";return!1};var n=c("us-btn-close");n.value=k.IDS_CLOSE;n.setAttribute("tabindex",q+6,0);n.onclick=function(a){p.onCancel()};var r=document.getElementsByClassName("us-cert-import-content")[0];r.setAttribute("tabindex",q+1,0);r.onclick=function(a){a.preventDefault();s("cert-info","hide")&&(document.getElementById("us-cert-import-file").onchange=function(a){var b=x(a.target.files);if(null!=b)alert(b);else for(b=0;b<a.target.files.length;b++)v(a.target.files[b])},document.getElementById("us-cert-import-file").click())};r.onkeydown=function(a){13==a.keyCode&&s("cert-info","hide")&&(document.getElementById("us-cert-import-file").onchange=function(a){var b=x(a.target.files);if(null!=b)alert(b);else for(b=0;b<a.target.files.length;b++)v(a.target.files[b])},document.getElementById("us-cert-import-file").click())};r.ondragleave=function(a){a.preventDefault()};r.ondragover=function(a){s("cert-info","hide")&&(m("us-cert-import-content","drop-here"),e("us-cert-import-content","drag"),m("view-panel","hide"),e("drop-plz","hide"));a.preventDefault()};r.ondrop=function(a){a.preventDefault();if(s("cert-info","hide")){e("us-cert-import-content","drop-here");m("us-cert-import-content","drag");m("view-panel","hide");e("basic","hide");a=a.dataTransfer.files;var b=x(a);if(null!=b){alert(b);return}for(b=0;b<a.length;b++)v(a[b])}return!1};e("basic","hide");a.uiUtil().setRotationTabFocus(n,d,b);a.uiUtil().setRotationTabFocus(b,n,g);return f}()};return function(p){var u=a.uiLayerLevel,c=a.uiUtil().getOverlay(u),h=y({type:p.type,args:p.args,onConfirm:p.onConfirm,onCancel:p.onCancel});h.style.zIndex=u+1;a.ESVS.TargetObj.insertBefore(c,a.ESVS.TargetObj.firstChild);c.ondragleave=function(a){null==a.relatedTarget&&s("cert-info","hide")&&(e("us-cert-import-content","drop-here"),m("us-cert-import-content","drag"),m("view-panel","hide"),e("basic","hide"));a.preventDefault()};var t=window.onresize;return{show:function(){draggable(h,document.getElementById("us-div-cert-manage-title"));c.style.display="block";a.uiUtil().offsetResize(h);window.onresize=function(){a.uiUtil().offsetResize(h)};a.uiLayerLevel+=10;a.ESVS.TabIndex+=30;setTimeout(function(){var a=h.getElementsByTagName("p");if(0<a.length)for(var c=0;c<a.length;c++)"us-import-cert-lbl-title"==a[c].id&&a[c].focus()},10)},hide:function(){c.style.display="none";h.style.display="none"},dispose:function(){window.onresize=function(){t&&t()};h.parentNode.parentNode.removeChild(h.parentNode);c.parentNode.removeChild(c);a.uiLayerLevel-=10;a.ESVS.TabIndex-=30}}}};